{% extends 'admin_base.html' %}

{% block title %}Genkan Institute - Admin Kelas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-6 py-8 bg-blue-50 sakura-bg">
  <h2 class="text-4xl font-bold mb-6 text-blue-700 animate-fade-in">Kelola Kelas</h2>

  <!-- Flash Messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="mb-6 p-4 rounded-xl flex items-center {% if category == 'success' %}bg-green-50 text-green-800 border border-green-200{% else %}bg-red-50 text-red-800 border border-red-200{% endif %} animate-fade-in">
          <svg class="w-6 h-6 mr-2" fill="currentColor" viewBox="0 0 20 20">
            {% if category == 'success' %}
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
            {% else %}
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
            {% endif %}
          </svg>
          {{ message }}
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- FORM TAMBAH KELAS -->
  <form method="POST" enctype="multipart/form-data" class="mb-10 bg-white p-8 rounded-2xl shadow-xl card border border-blue-100 animate-fade-in">
    <h3 class="text-2xl font-bold mb-6 text-blue-700 flex items-center">
      <svg class="w-7 h-7 mr-2 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
      </svg>
      Tambah Kelas Baru
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
      <input type="hidden" name="action" value="create">
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Level</label>
        <input type="text" name="level" placeholder="A1-A" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Judul</label>
        <input type="text" name="title" placeholder="Kelas Pemula A1" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Deskripsi</label>
        <textarea name="description" rows="3" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition"></textarea>
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Status</label>
        <select name="status" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
          <option value="ongoing">Berlangsung</option>
          <option value="upcoming">Segera Dibuka</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Tanggal Mulai</label>
        <input type="date" name="start_date" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Jadwal</label>
        <input type="text" name="schedule" placeholder="Senin & Rabu, 19:00" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Spot Tersedia</label>
        <input type="number" name="spots_available" value="10" min="0" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Batch ID</label>
        <input type="text" name="batch_id" placeholder="2025-01" class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Prerequisite Level</label>
        <input type="text" name="prerequisite_level" placeholder="A1-C (kosongkan jika tidak ada)" class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div>
        <label class="block text-sm font-semibold text-blue-700 mb-1">Harga (Rp)</label>
        <input type="number" name="price" step="0.01" placeholder="500000" required class="w-full px-4 py-3 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400 focus:border-transparent transition">
      </div>
      <div class="md:col-span-2 lg:col-span-3">
        <label class="block text-sm font-semibold text-blue-700 mb-1">Gambar Kelas</label>
        <input type="file" name="image_file" accept="image/*" class="w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
      </div>
      <div class="md:col-span-2 lg:col-span-3">
        <button type="submit" class="w-full btn-success py-3 rounded-xl font-medium shadow-md hover:shadow-lg transition animate-pulse-slow">Tambah Kelas</button>
      </div>
    </div>
  </form>

  <!-- DAFTAR KELAS -->
  <h3 class="text-2xl font-bold mb-6 text-blue-700 animate-fade-in">Daftar Kelas</h3>
  {% if kelas_items %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
      {% for item in kelas_items %}
      <div class="bg-white rounded-2xl shadow-xl overflow-hidden card border border-blue-100">
        <!-- Gambar -->
        <div class="relative h-48 w-full">
          {% if item.image_id %}
            <img src="{{ url_for('serve_image', image_id=item.image_id) }}" alt="{{ item.title }}" class="w-full h-full object-cover">
          {% else %}
            <div class="bg-gray-200 border-2 border-dashed rounded-xl w-full h-48 flex items-center justify-center text-gray-500 text-sm">
              Tidak ada gambar
            </div>
          {% endif %}
        </div>
        <div class="p-6">
          <h4 class="text-xl font-bold text-blue-700 mb-2">{{ item.level }} - {{ item.title }}</h4>
          <p class="text-sm text-gray-600 mb-2">Rp {{ "{:,.0f}".format(item.price) }}</p>
          <p class="text-sm text-gray-500 mb-1"><strong>Status:</strong> <span class="{% if item.status == 'ongoing' %}text-green-600{% else %}text-yellow-600{% endif %} capitalize">{{ item.status }}</span></p>
          <p class="text-sm text-gray-500 mb-1"><strong>Mulai:</strong> {{ item.start_date }}</p>
          <p class="text-sm text-gray-500 mb-1"><strong>Jadwal:</strong> {{ item.schedule }}</p>
          <p class="text-sm text-gray-500 mb-1"><strong>Spot:</strong> {{ item.spots_available }}/10</p>
          <p class="text-sm text-gray-500 mb-1"><strong>Batch:</strong> {{ item.batch_id or '-' }}</p>
          <p class="text-sm text-gray-500 mb-4"><strong>Prasyarat:</strong> {{ item.prerequisite_level or 'Tidak ada' }}</p>

          <!-- FORM UPDATE & DELETE -->
          <form method="POST" enctype="multipart/form-data" class="mt-4 space-y-4">
            <input type="hidden" name="id" value="{{ item._id }}">
            <div class="grid grid-cols-1 gap-3 text-sm">
              <input type="text" name="level" value="{{ item.level }}" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <input type="text" name="title" value="{{ item.title }}" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <textarea name="description" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400" rows="2">{{ item.description }}</textarea>
              <select name="status" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
                <option value="ongoing" {% if item.status == 'ongoing' %}selected{% endif %}>Berlangsung</option>
                <option value="upcoming" {% if item.status == 'upcoming' %}selected{% endif %}>Segera Dibuka</option>
              </select>
              <input type="date" name="start_date" value="{{ item.start_date }}" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <input type="text" name="schedule" value="{{ item.schedule }}" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <input type="number" name="spots_available" value="{{ item.spots_available }}" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <input type="text" name="batch_id" value="{{ item.batch_id or '' }}" placeholder="2025-01" class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <input type="text" name="prerequisite_level" value="{{ item.prerequisite_level or '' }}" placeholder="A1-C" class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <input type="number" name="price" value="{{ item.price }}" step="0.01" required class="px-3 py-2 rounded-lg border border-blue-200 focus:ring-2 focus:ring-blue-400">
              <div>
                <label class="block text-xs text-blue-700">Ganti Gambar</label>
                <input type="file" name="image_file" accept="image/*" class="text-xs w-full text-gray-500 file:mr-3 file:py-1 file:px-3 file:rounded-full file:border-0 file:text-xs file:bg-blue-50 file:text-blue-700">
              </div>
            </div>
            <div class="flex gap-3">
              <button type="submit" name="action" value="update" class="flex-1 btn-primary py-2.5 rounded-xl shadow-md hover:shadow-lg transition">Update</button>
              <button type="submit" name="action" value="delete" onclick="return confirm('Yakin hapus kelas ini? Gambar akan ikut terhapus.')" class="flex-1 btn-danger py-2.5 rounded-xl shadow-md hover:shadow-lg transition">Hapus</button>
            </div>
          </form>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="text-center py-16 bg-white rounded-2xl shadow-lg border border-blue-100 animate-fade-in">
      <p class="text-xl text-blue-600 font-medium">Belum ada kelas. Yuk tambah yang pertama!</p>
    </div>
  {% endif %}
</div>
{% endblock %}